% % say that lammps and matlab were used in Introduction

\documentclass[BTech]{iitmdiss}
\usepackage{textcomp}
\usepackage{times}
%\usepackage{breqn}
\usepackage{tabularx}
\usepackage{url}
\usepackage{rotating}
\usepackage{adjustbox}
\usepackage{mathtools}
%\usepackage{geometry}
\usepackage{pbox}
\usepackage{multirow}
%\usepackage[paper=a4paper,left=1.5in,right=1in,top=1in,bottom=0.667in,nohead]{geometry}
\usepackage{float}
\usepackage{t1enc}
\usepackage{wrapfig}
\usepackage{graphicx}
\usepackage{epstopdf}
\usepackage{lipsum}
\newcommand{\startsquarepar}{%
    \par\begingroup \parfillskip 0pt \relax}
\newcommand{\stopsquarepar}{%
    \par\endgroup}
\usepackage[driverfallback=dvipdfm]{hyperref} % hyperlinks for references.
\usepackage{amsmath} % easier math formulae, align, subequations \ldots
\ProvideTextCommand{\DJ}{OT1}{\raisebox{0.25ex}{-}\kern-0.4em D}
\usepackage{paracol}
\usepackage{subfig}
\usepackage{siunitx}


\usepackage{pgfplots}
\pgfplotsset{compat=1.15}
\usepackage{mathrsfs}
\usepackage{color}
\usetikzlibrary{arrows}
\newcommand{\degre}{\ensuremath{^\circ}}

\definecolor{cqcqcq}{rgb}{0.7529411764705882,0.7529411764705882,0.7529411764705882}
\definecolor{ffqqqq}{rgb}{1,0,0}



\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Title page
    \newcommand{\titleText}{Remote Center of Motion Constrained Planning for a 7DOF Robotic Arm}
    \newcommand{\authorText}{Suraj Rathi}
    \title{\titleText}

    \author{\authorText}

    \date{25 May 2023}
    \department{Mechanical Engineering}

%\nocite{*}
%\RequirePackage[ %compat2,a4paper,left=1.5in,right=1in,top=1in,bottom=0.667in,                nohead]{geometry}[2002/07/08]
    \newgeometry{left=1in,right=1.5in,top=1in,bottom=0.667in}
    \maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Certificate
    \certificate

    \vspace*{0.5in}

    \noindent This is to certify that the thesis titled {\bf \titleText}, submitted by {\bf \authorText},
    to the Indian Institute of Technology, Madras, for
    the award of the degree of {\bf B.Tech}, is a bona fide
    record of the research work done by him under my supervision. The
    contents of this thesis, in full or in parts, have not been submitted
    to any other Institute or University for the award of any degree or
    diploma.

    \vspace*{1.5in}

    \begin{paracol}{2}
        \begin{singlespacing}
            \hspace*{-0.25in}
            \parbox{2.5in}{
                \noindent {\bf Dr.\ Nirav Patel} \\
                \noindent Research Guide \\
                \noindent \textit{Assistant Professor} \\
                \noindent Dept. of Engineering Design\\
                \noindent IIT-Madras, 600 036
            }
            \hspace*{1.56in}

            \vspace*{0.3in}
            \noindent Place: Chennai\\
            Date: 25$^{\textnormal{th}}$ May 2023

        \end{singlespacing}

        \switchcolumn
        \begin{singlespacing}
            \hspace*{-0.25in}
            \parbox{2.5in}{
                \noindent {\bf Dr.\ Sathyan Subbiah} \\
                \noindent Research Guide \\
                \noindent \textit{Professor} \\
                \noindent Dept. of Mechanical Engineering\\
                \noindent IIT-Madras, 600 036
            }
            \hspace*{1.56in}

            \vspace*{0.3in}
            \noindent Place: Chennai\\
            Date: 25$^{\textnormal{th}}$ May 2023

        \end{singlespacing}

    \end{paracol}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Acknowledgements
    \newgeometry{left=1.5in,right=1in,top=1in,bottom=0.667in}
    \acknowledgements

    I would like to thank my guides, Dr.\ Nirav Patel, Dept of Engineering Design, and Dr.\ Sathyan Subbiah, Dept. of Mechanical Engineering for their guidance and support throughout this project.
    Nirav Sir has been supporting me on every aspect of my work from day one, providing valuable experience from his long career.
    Whenever we are at a fork in the road, sir has always been able to provide valuable insights on which direction to proceed.
    I am forever grateful for the knowledge I gained while working under him.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Abstract

    \abstract

    \noindent KEYWORDS: \hspace*{0.5em} \parbox[t]{4.4in}{Path Planning; Inverse Kinematics; KUKA LBR iiwa R800}

    \vspace*{24pt}
    \noindent
    In this project we attempt to build a realtime path planner satisfying a remote center of motion constraint.
    After ensuring the method will converge to a solution, the optimization objective is to minimize the total joint motion and to enforce motion limits on each joint.
    We set up a simulation using Open Roboticsâ€™ Gazebo to conduct our experiments in conjunction with the ROS platform.
    We worked to identify the challenges faced by planning in task space using Inverse-Kinematics.
    Sampling based methods were then used to improve the performance.
    Our work demonstrates the effectiveness of task space Inverse-Kinematics based methods.



    \pagebreak

    \disclaimer
    The Department of Mechanical Engineering, IIT Madras and the staff of IIT Madras, do not accept any responsibility for the truth, accuracy or completeness of material contained within or associated with this dissertation.

    Persons using all or any part of this material do so at their own risk, and not at the risk of the Department of Mechanical Engineering, IIT Madras and the staff of IIT Madras,

    This document, the associated hardware, software, drawings, and other material set out in the associated appendices should not be used for any other purpose: if they are so used, it is entirely at the risk of the user

    \pagebreak


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Table of contents etc.

    \begin{singlespace}
        \tableofcontents
        \thispagestyle{empty}

        \listoftables
        \addcontentsline{toc}{chapter}{LIST OF TABLES}
        \listoffigures
        \addcontentsline{toc}{chapter}{LIST OF FIGURES}
    \end{singlespace}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Abbreviations
    \newpage
    \begin{tabbing}

    \end{tabbing}
    \abbreviations

    \noindent
    \begin{tabbing}
        xxxxxxxxxxxxxx \= xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx \kill
        \textbf{RCM} \> Remote Center of Motion\\
        \textbf{DOF} \> Degrees of Freedom\\

    \end{tabbing}

    \pagebreak

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Notation

    \chapter*{\centerline{NOTATIONS}}
    \addcontentsline{toc}{chapter}{NOTATIONS}

    TODO: Notations
    \begin{singlespace}
        \begin{tabbing}
            xxxxxxxxxxx \= xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx \kill
            $F$ \>  Force (N)\\
            $\delta$ \> Displacement (m)\\

        \end{tabbing}
    \end{singlespace}

    \pagebreak
    \clearpage

% The main text will follow from this point so set the page numbering
% to arabic from here on.
    \pagenumbering{arabic}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Introduction.


    \chapter{INTRODUCTION}\label{ch:intro}


    \section{Motivation}\label{sec:motiv}
    Laparoscopic surgery, commonly know as `keyhole' surgery, is a procedure where a surgeon accesses the inside of
    the abdomen and pelvis without having to make a large incision.
    We are attempting to use a LBR iiwa 7~[\cite{AG}] arm produced by KUKA, which is a 7DOF robotic arm, to perform such a surgery.

    In this surgery, a small incision is made on the skin, and the surgical instruments are manipulated through that incision.
    We have model this as a cylindrical, and later circular, shape.
    The endeffector must always enter through the upper circular face and exit through the lower circular face.
    It must always pass through some volume of the cylinder and cannot intersect with the curved surface.
    An illustration can be seen in~\ref{fig:RCM}.
    This is quite similar to the `Remote Center of Motion' (RCM) constraint and henceforth, when we use the term RCM we will be referring to the aforementioned constraint.

    \begin{figure}
        \centering
        \includegraphics[height= 0.5\textwidth]{./img/rcm-constraint}
        \caption{A depiction of the Laproscopic surgery constraint as implemented in our work. The orange and gray objects are part of the robotic arm and the red cylinder represents the volume through which the end-effector must always pass.}
        \label{fig:RCM}
    \end{figure}

    We wished to implement a real-time path planner that can satisfy the RCM constraint.


    \section{Survey of Existing Methods}

    \subsection{Path Planners}
    Our survey of existing planning methods was primarily done by surveying the available algorithms in ROS MoveIT [\cite{Coleman_Sucan_Chitta_Correll_2014}].
    This library provides a unified frontend to various motion planners and integrates wil the FCL collision checker, and with simulation and visualization software through the ROS framework.
    We must note that these planners are optimized for a general purpose use case.
    Our robot is very simple, and when it is inside the RCM, we observed that the links do not collide with each-other we do not require all the complexities and features of these full scale planners.

    \emph{TODO: go into detail about different planners?}

    A second technique can be used, wherein if we can generate a path in task space (i.e. in the coordinates of the tip of the end-effector),
    we can use Inverse Kinematics (IK) to generate the required joint angles in configuration space. This approach generally has the following problems.
    \begin{enumerate}
        \item Solving the IK problem may be slow
        \item There may be no IK solution for a given pose
        \item The IK solution will not be unique
        \item There may be large jumps in IK solutions between two consecutive points in the path.
    \end{enumerate}

    The Kinematics and Dynamics Library (KDL)~[\cite{kdl-url}] is default solver used by MoveIT for solving forward and inverse kinematics problems.
    We can also use the IKFast algorithm to generate analytical solutions for a given robot configuration.

    \subsection{7DOF Robot Control}

    Another challenge with working with this robot is its the over-actuated nature.
    To control the six DOF of the end-effector pose, we need to specify the joint angle of seven actuators.
    This leaves us with one extra DOF.
    In literature, we have seen others use that DOF to implement better obstacle avoidance~[\cite{Doliwa_2020}] and lock a single joint to get closed form kinematics~[\cite{Asthana}]


    \section{Objectives}

    \begin{enumerate}
        \item Build a simulated environment using the KUKA LBR iiwa 7 with the RCM constraint in Gazebo and integrate it with the ROS MoveIT framework.
        \item Identify challenges with implementing the RCM constraint using task-space planning and Inverse Kinematics.
        \item Implement and test the effectiveness of a sampling based technique to minimize the joint motion along the path.
    \end{enumerate}


    \section{Risk Assessment}

    TODO: Fill this


    \section{Resource Requirements}
    The following resources were used to complete this work:
    \begin{itemize}
        \item TODO: Fill this
    \end{itemize}


    \chapter{METHODOLGY}\label{ch:method}


    \section{Simulation Building}

    We built our simulation using the Gazebo~[\cite{gazebo-url}] simulator.
    It is a widely-used open-source robotics simulator that provides a realistic 3D environment for developing and testing robot algorithms.

    We used~\cite{hennersperger2017towards} as the basis of the simulated environment and added a needle shaped end-effector and a ellipsoidal model of an abdomen.
    The initial simulation environment is seen in \ref{fig:initial_simulation_models}.
    The `abdomen' model enforces the RCM constraint.

    \begin{figure}%
        \centering
        \subfloat[\centering End Effector]{{\includegraphics[height=0.25 \linewidth]{./img/initial_endeffector}}}%
        \qquad
        \subfloat[\centering Abdomen]{{\includegraphics[height=0.25 \textwidth]{./img/initial_abdomen}}}%
        \qquad
        \subfloat[\centering Visualization]{{\includegraphics[height=0.25 \textwidth]{./img/initial_sim_env_viz}}}%
        \caption{The initial models for use in simulation}
        \label{fig:initial_simulation_models}
    \end{figure}

    The models were slowly changed as the project progressed to better model the problem of Laparoscopic surgery.
    The dimensions of the end effector were changed to a length of \SI{350}{\milli\meter} and base radius of \SI{2}{\milli\meter} (\ref{fig:longer_ee}).

    \begin{figure}
        \centering
        \includegraphics[width=0.75 \linewidth]{./img/longer_end_effector}
        \caption{The longer end effector.}
        \label{fig:longer_ee}
    \end{figure}

    Another major change in the simulation was to change the cylindrical RCM \ref{fig:rcm_cylinder} to a circular RCM \ref{fig:rcm_circle}.
    The circular model can be represented as the cylindrical model where the height of the cylinder is 0.

    \begin{figure}
        \centering
        \input{./img/rcm_cylinder.txt}
        \caption{The original RCM model. The red region represents the RCM and the gray region represents the end effector.}
        \label{fig:rcm_cylinder}
    \end{figure}

    \begin{figure}
        \centering
        \input{./img/rcm_circle.txt}
        \caption{The new RCM model. The red region represents the RCM and the gray region represents the end effector.}
        \label{fig:rcm_circle}
    \end{figure}

    With this setup, we were able to run the full ROS MoveIT planning stack with generic algorithms.
    However, using the mesh as a constraint for the RCM is extremely slow, and this naive approach would not run in real-time.


    \section{Inverse Kinematics}

    As is used by ROS MoveIT, we leveraged the KDL library for solving the forward and inverse kinematic models.
    Do note that we are using a patched version of the pyKDL library, see Appendix~\ref{ch:code}.

    The KDL library uses an implementation of `Differential Inverse Kinematics'.
    In this method the SVD decomposition of the Jacobian is used to calculate the configuration space velocity for a given task space velocity.
    With this, the Newton-Raphson method is used to find an IK solution (configuration-space state) given a prior state.

    We found that in practice, this method provided the following:
    \begin{enumerate}
        \item Real-time solutions to the IK problem.
        \item A deterministic and unique IK solution.
        \item No large jumps in solutions because of the gradient based nature of the technique
    \end{enumerate}

    The final guarantee that still needs to be shown, is that we must be able to find an IK solution at all points in the workspace.
    Firstly, based on the RCM constrataint model, we can take the workspace as the combination of a cone with its apex at the RCM
    and axis along the vertical and a spherical cap with its center as the cone's apex.
    With the RCM constraint, we have a limited workspace area, so we can discretize the workspace and check whether a
    solution can be found.

    TODO: Add images of the workspace

    We used an implementation of floodfill to iterate through all states in the workspace, starting from an initial state
    and use the IK solver to calculate a solution and store the total change in joint angle, position error, and orientation error.
    The IK solver is seeded from the IK solution of the previous state.
    The implementation with a FIFO queue ensures that for a given state, the IK solution is seeded by that of a state which is closer to the starting point.

    If the joint values at each point were of small enough magnitude, then we get a weak guarantee of it possible to find an IK solution at each point.
    The guarantee is weak as we are only checking from an initial point outwards, not from any point A to another adjacent point.


    \section{RCM Implementation}

    \subsection{Simple Implementation}\label{subsec:simple-rcm-impl}

    As input to the IK routine, we need to provide a 6DOF pose.
    This consists of the end effector's cartesian position and orientation.
    The cartesian position is provided to us as the input to the algorithm (target point).
    This leaves us with 3DOF from the orientation to implement the RCM constraint.
    As seen in figure \ref{fig:target_orientation}, we've taken a ray from the center of the upper face of the RCM to the target point.
    We then find the smallest rotation transforming a coordinate axis such that the x axis will lie along that vector.

    \begin{figure}
        \centering
        \includegraphics[width=0.5 \linewidth]{./img/target_orientation}
        \caption{The black vector shows the required orientation of the end effector. The pink cylinder represents the RCM constraint.}
        \label{fig:target_orientation}
    \end{figure}


    In ROS, rotations between two coordinate frames are represented as quaternions.
    We need to find the quaternion that represents the minimum rotation between the base frame and the target frame.
    See figure \ref{fig:coordinate_frames} for reference.
    Let $\vec{O}$ represent the center of the upper face of the cylinder and $\vec{t}$ represent the target position.
    From equation \ref{eqn:final_q}, we can get the final expression for the orientation as a quaternion.
    In the implementation we have had add support for special cases where this expression can approach $\infty$.

    \begin{align}
        \vec{d} &= \vec{t} - \vec{O} \\
        \vec{l} &= \frac{(0, 0, -1) \times \vec{d}}{|\vec{d}|} \\
        \theta &= \arccos{\left(\frac{(0, 0, -1) \cdot \vec{d}}{|\vec{d}|}\right)} \\
        \mathbf{q} &= \cos{\frac{\theta}{2}} + \left(l_x \mathbf{i} + l_y \mathbf{j} + l_z \mathbf{k} + \right) \sin{\frac{\theta}{2}} \label{eqn:final_q}
    \end{align}


    \begin{figure}
        \centering
        \includegraphics[width=0.5 \linewidth]{./img/coordinate_frames}
        \caption{The set of red, green, and blue line segments represent the x, y, and z axes of a coordinate frame.
        The upper frame is the frame of reference (base frame) for the target frame.}
        \label{fig:coordinate_frames}
    \end{figure}

    \subsection{Sampling Based Implementation}

    In section~\ref{subsec:simple-rcm-impl} we have taken an arbitrary point in the RCM through which the center of our
    end-effector must pass through.
    However, we know that the end effector can pass through any point in the upper face,
    as long as the end-effector will not intersect with the curved surface of the cylinder.
    We can then choose the point to minimize an optimization criterion.

    As the IK solver is a non-analytical technique, we cannot find an analytical solution for this technique.
    Instead, we can attempt to find the best point by random sampling. The process can be seen in figure \ref{fig:sampling_flowchart}.

    \begin{figure}
        \centering

        \input{./img/sampling_flowchart.txt}

        \caption{Flowchart depicting the Sampling based RCM implementation.}
        \label{fig:sampling_flowchart}
    \end{figure}

    A mathematical representation of the RCM constraints was developed for the cylindrical and circular case.
    Let the center of the upper face of the RCM be denoted by $\vec{O}$, the point we have chosen on the upper face be $\vec{P}$,
    the radius of the RCM $R$, the radius of the end-effector $r$, and the thickness of the RCM be $t$.
    The equation \ref{eqn:cylinder_cons} lays out the required condition for a cylindrical constraint.
    In the implementation, we have taken care to handle the cases where we are dividing by the norm of a very small vector.

    \begin{align}
        \vec{O'} &= \vec{O} + (0, 0, -t) \\
        \vec{Q'} &= \vec{Q} - (\vec{P} - \vec{Q}) * \frac{t}{P_z - Q_z} \\
        d_{upper} &= (R - |\vec{Q} - \vec{O}|) * \frac{|(\vec{P} - \vec{Q}) \times (\vec{O} - \vec{Q})|}{|\vec{P} - \vec{Q}| |\vec{O} - \vec{Q}|} \\
        d_{lower} &= (R - |\vec{Q'} - \vec{O'}|) * \frac{|(\vec{P} - \vec{Q'}) \times (\vec{O'} - \vec{Q'})|}{|\vec{P} - \vec{Q'}| |\vec{O'} - \vec{Q'}|} \\
        is_{valid} &= (d_{upper} > r) \land (d_{lower} > r)\label{eqn:cylinder_cons}
    \end{align}

    When we later shifted to a circular constraint, we used just $d_{upper}$.
    The calls to the underlying vector mathematics library (numpy) were manually inlined and unrolled to increase speed.


    \chapter{RESULTS}\label{ch:results}


    \section{Feasibility of Inverse Kinematics Based Methods}

    Show the reachability

    Show the speed

    TODO: Reachability Graphs (3d heatmap)


    \section{Sampling Based Implementation of the RCM Constraint}

    show the paths taken, show the
    TODO: comparison of performance along a path, look into


    \chapter{CONCLUSION}\label{ch:conclusion}


    \section{Conclusion}

    TODO: feasibility of IK, our sampling did not work future sampling based improvements, better RCM modelling


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Appendices.

    \appendix


    \chapter{Accessing and Running the Package} \label{ch:code}

    TODO:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Bibliography.

    \begin{singlespace}
        \bibliography{thesis_template}
        % \bibliographystyle{iitm}
    \end{singlespace}

\end{document}
